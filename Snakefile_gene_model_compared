# A global singularity image to be used for all jobs - need to specify --use-singularity and have singularity available on the command line
# This image already contains the bioinformatic tools we will be using singularity:
#"file:///shared/.singularity/nextflow-embl-abr-webinar.simg", 
"docker://rsuchecki/nextflow-embl-abr-webinar"

configfile: "config.yaml"

SAMPLES1           = config["SAMPLES1"]
ENVS               = config["ENVS"]
REFERENCES	   = config["REFERENCES"]
LOGS               = config["LOGS"]
DIR                = config["DIR9"]
GENE_MODEL_RNA     = config["GENE_MODEL7"]
GENE_MODEL_PROTEIN = config["GENE_MODEL8"]
GENE_MODEL	   = config["GENE_MODEL9"]
ANNOTATION	   = config["ANNOTATION8"]
COUNTS             = config["COUNTS9"]
BAM1               = config["BAM9_1"]
NON_CODING         = config["NON_CODING"] 




################
# Pseudo-rules #
################
# By convention, the first rule should be called "all" and it's "input" defined as
# the list of ALL the files you want the workflow to create. e.g.:
rule all:
	input:
		GENE_MODEL+"/gene_model_RNA_exon.gff3",
		GENE_MODEL+"/candidate_ncRNA.gff3",
		GENE_MODEL+"/candidate_ncRNA_inter_anti.gff3",
		GENE_MODEL+"/candidate_ncRNA_intergenic.gff3",
		#GENE_MODEL+"/protein_noRNAdata.gff3",
		GENE_MODEL+"/candidate_ncRNA_intronicexonic.gff3",
		GENE_MODEL+"/candidate_ncRNA_antisense.gff3",
		GENE_MODEL+"/transcript/sncRNA.gff3",
		GENE_MODEL+"/transcript/sncRNA_intergenic.gff3",
		GENE_MODEL+"/transcript/sncRNA_intronicexonic.gff3",
		GENE_MODEL+"/transcript/sncRNA_antisense.gff3",
		GENE_MODEL+"/transcript/lncRNA.gff3",
		GENE_MODEL+"/transcript/lncRNA_intergenic.gff3",
		GENE_MODEL+"/transcript/lncRNA_intronicexonic.gff3",
		GENE_MODEL+"/transcript/lncRNA_antisense.gff3",
		expand(GENE_MODEL+"/transcript/{SAMPLE}.fasta", SAMPLE=NON_CODING),
		GENE_MODEL+"/rnacentral/rnacentral_species_specific_ids.fasta.nal",
		expand(GENE_MODEL+"/transcript/{SAMPLE}_blastn.outfmt6", SAMPLE=NON_CODING),
		#expand(GENE_MODEL+"/transcript/{SAMPLE}_tblastx.outfmt6", SAMPLE=NON_CODING),
		GENE_MODEL+"/gene_model_merge.gff3",
		COUNTS+"/counts.out",


################
# Rules Proper #
################

rule gene_model_RNA:
	input:
		GENE_MODEL_PROTEIN+"/gene_model_RNA.gff3",
	output:
		GENE_MODEL+"/gene_model_RNA_exon.gff3",
	shell:
		"""
		sed -e "s/match/exon/g" {input} > {output}
		"""

rule compare_gene_model:
	input:
		rna = GENE_MODEL+"/gene_model_RNA_exon.gff3",
		protein = GENE_MODEL_PROTEIN+"/gene_model_protein.gff3",
	output:
		candidate_nc_all = GENE_MODEL+"/candidate_ncRNA.gff3",
		candidate_nc_inter_anti = GENE_MODEL+"/candidate_ncRNA_inter_anti.gff3",
		candidate_nc_intergenic = GENE_MODEL+"/candidate_ncRNA_intergenic.gff3",
		absence_features = GENE_MODEL+"/absence_features.gff3"
	conda:
		ENVS
	shell:
		"""
		bedtools intersect -a {input.rna} -b {input.protein} -v -s -f 1 -F 1 > {output.candidate_nc_all} &&
		bedtools intersect -a {input.rna} -b {input.protein} -v -s > {output.candidate_nc_inter_anti} &&
		bedtools intersect -a {input.rna} -b {input.protein} -v > {output.candidate_nc_intergenic} &&
		bedtools intersect -a {input.protein} -b {input.rna} -v -s -f 1 -F 1 > {output.absence_features}
		"""

rule group_ncRNA:
	input:
		candidate_nc_all = GENE_MODEL+"/candidate_ncRNA.gff3",
		candidate_nc_inter_anti = GENE_MODEL+"/candidate_ncRNA_inter_anti.gff3",
		candidate_nc_intergenic = GENE_MODEL+"/candidate_ncRNA_intergenic.gff3",
	output:
		candidate_nc_introexo = GENE_MODEL+"/candidate_ncRNA_intronicexonic.gff3",
		candidate_nc_antisense = GENE_MODEL+"/candidate_ncRNA_antisense.gff3",
	conda:
		ENVS
	shell:
		"""
		bedtools intersect -a {input.candidate_nc_all} -b {input.candidate_nc_inter_anti} -v -s -f 1 -F 1 > {output.candidate_nc_introexo} && 
		bedtools intersect -a {input.candidate_nc_inter_anti} -b {input.candidate_nc_intergenic} -v -s -f 1 -F 1 > {output.candidate_nc_antisense}
		"""

rule group_lncRNA:
	input:
		ncRNA = GENE_MODEL+"/candidate_ncRNA.gff3",
		ncRNA1 = GENE_MODEL+"/candidate_ncRNA_intergenic.gff3",
		ncRNA2 = GENE_MODEL+"/candidate_ncRNA_intronicexonic.gff3",
		ncRNA3 = GENE_MODEL+"/candidate_ncRNA_antisense.gff3"
	output:
		lncRNA = GENE_MODEL+"/transcript/lncRNA.gff3",
		lncRNA1 = GENE_MODEL+"/transcript/lncRNA_intergenic.gff3",
		lncRNA2 = GENE_MODEL+"/transcript/lncRNA_intronicexonic.gff3",
		lncRNA3 = GENE_MODEL+"/transcript/lncRNA_antisense.gff3"
	shell:
		"""
		awk "\$5-\$4>=200" {input.ncRNA} > {output.lncRNA} &&
		awk "\$5-\$4>=200" {input.ncRNA1} > {output.lncRNA1} &&
		awk "\$5-\$4>=200" {input.ncRNA2} > {output.lncRNA2} &&
		awk "\$5-\$4>=200" {input.ncRNA3} > {output.lncRNA3}
		"""

rule group_sncRNA:
	input:
		ncRNA = GENE_MODEL+"/candidate_ncRNA.gff3",
		ncRNA1 = GENE_MODEL+"/candidate_ncRNA_intergenic.gff3",
		ncRNA2 = GENE_MODEL+"/candidate_ncRNA_intronicexonic.gff3",
		ncRNA3 = GENE_MODEL+"/candidate_ncRNA_antisense.gff3"
	output:
		sncRNA = GENE_MODEL+"/transcript/sncRNA.gff3",
		sncRNA1 = GENE_MODEL+"/transcript/sncRNA_intergenic.gff3",
		sncRNA2 = GENE_MODEL+"/transcript/sncRNA_intronicexonic.gff3",
		sncRNA3 = GENE_MODEL+"/transcript/sncRNA_antisense.gff3"
	shell:
		"""
		awk "\$5-\$4<100" {input.ncRNA} > {output.sncRNA} &&
		awk "\$5-\$4<100" {input.ncRNA1} > {output.sncRNA1} &&
		awk "\$5-\$4<100" {input.ncRNA2} > {output.sncRNA2} &&
		awk "\$5-\$4<100" {input.ncRNA3} > {output.sncRNA3}
		"""

rule protein_noRNAdata:
	input:
		GENE_MODEL+"/absence_features.gff3"
	output:
		GENE_MODEL+"/protein_noRNAdata.gff3"
	shell:
		"""
		grep "exon" {input} > {output}
		"""

rule ncRNA_fasta:
	input:
		references = REFERENCES+"/Plantago.fasta",
		ncRNA = GENE_MODEL+"/transcript/{SAMPLE}.gff3",
	output:
		ncRNA = GENE_MODEL+"/transcript/{SAMPLE}.fasta",
	conda:
		ENVS
	log:
		LOGS+"/{SAMPLE}.log",
	shell:
		"""
		bedtools getfasta -fullHeader -fo {output.ncRNA} -fi {input.references} -bed {input.ncRNA} 
		2> {log}
		"""

rule database_ncRNA:
	input:
		GENE_MODEL+"/rnacentral/rnacentral_species_specific_ids.fasta"
	output:
		GENE_MODEL+"/rnacentral/rnacentral_species_specific_ids.fasta.nal"
	conda:
		ENVS
	shell:
		"""
		makeblastdb -in {input} -dbtype nucl
		"""

rule blastn:
	input:
		GENE_MODEL+"/transcript/{SAMPLE}.fasta"
	output:
		GENE_MODEL+"/transcript/{SAMPLE}_blastn.outfmt6"
	conda:
		ENVS
	params:
		GENE_MODEL+"/rnacentral/rnacentral_species_specific_ids.fasta"
	shell:
		"""
		blastn -query {input} -db {params} -max_target_seqs 1 \
		-outfmt '6 qseqid sseqid stitle pident length mismatch gapopen qstart qend sstart send evalue bitscore' \
		-evalue 1e-3 -num_threads 8 -out {output}
		"""

rule tblastx:
	input:
		GENE_MODEL+"/transcript/{SAMPLE}.fasta"
	output:
		GENE_MODEL+"/transcript/{SAMPLE}_tblastx.outfmt6"
	conda:
		ENVS
	params:
		GENE_MODEL+"/rnacentral/rnacentral_species_specific_ids.fasta"
	shell:
		"""
		tblastx -query {input} -db {params} -max_target_seqs 1 \
		-outfmt '6 qseqid sseqid stitle pident length mismatch gapopen qstart qend sstart send evalue bitscore' \
		-evalue 1e-3 -num_threads 8 -out {output}
		"""

rule merge_gene_model:
	input:
		file1 = GENE_MODEL_PROTEIN+"/gene_model_RNA.gff3",
		file2 = GENE_MODEL_PROTEIN+"/gene_model_protein.gff3"
	output:
		GENE_MODEL+"/gene_model_merge.gff3"
	shell:
		"""
		cat {input.file1} {input.file2} > {output}
		"""

rule counts:
	input:
		bam = expand(BAM1+"/{SAMPLE}Aligned.sortedByCoord.out.bam", SAMPLE=SAMPLES1),
		gff = GENE_MODEL+"/gene_model_merge.gff3",
	output:
		COUNTS+"/counts.out",
	conda:
		ENVS
	log:
		LOGS+"/counts.summary"
	params:
		COUNTS
	shell:
		"""
		featureCounts -t gene -g ID -O -s 2 -p -T 5 -F GFF -a {input.gff} -o {output} {input.bam} \
		> {log}
		"""
